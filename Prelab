;*******************************************************************************************************************************************
; Universidad del Valle de Guatemala
; IE2023 Programaci√≥n de Microcontroladores
; Contador.asm
; Proyecto: Contador 4 Bits
; Hardware: ATMEGA328P
; Created: 1/30/2024 9:10:47 AM
; Author : Fatima
;********************************************************************************************************************************************

;********************************************************************************************************************************************
;ENCABEZADO
;********************************************************************************************************************************************

.include "M328PDEF.inc"
.cseg
.org 0x00

;********************************************************************************************************************************************
; STACK POINTER
;********************************************************************************************************************************************

LDI R16, LOW(RAMEND)
OUT SPL, R16
LDI R17, HIGH(RAMEND)
OUT SPH, R17


Setup:
	LDI R16, (1 << CLKPCE) ; Habilitar el prescaler
	STS CLKPR, R16 ; No es un espacio I/O entonces se usa STS
	LDI R16, 0b0000_0100
	STS CLKPR, R16 ; Dividir por 16 la frecuencia del reloj (1MHz)

	SBI DDRB, PB5
	CBI PORTB, PB5 ; limpiar el led del bit 6
	
	CALL Timer

	LDI R20, 0 ; Setear variables
	LDI R21, 0

	LDI R16, 0b1111_1111 
	OUT DDRB, R16 ; Configurar salidas en portB

Loop:
	IN R16, TIFR0
	CPI R16, (1<<TOV0) ; Si existe un overflow salir del loop
	BRNE Loop

	LDI R16, 97.65
	OUT TCNT0, R16 ;cargar aprox 100ms
	
	SBI TIFR0, TOV0 ; Limpiar el overflow

	INC R20 ; Incrementar el temp
	CPI R20, 10 ; aprox para poder llegar a los 1s
	BRNE Loop

	CLR R20

	INC R21 ; Incrementar el contador
	OUT PORTB, R21

	RJMP Loop

Timer:
	LDI R16, (1 << CS02) | (1 << CS00) ; Prescaler 1024
	OUT TCCR0B, R16

	LDI R16, 97.65 ; Aprox 100ms
	OUT TCNT0, R16
	RET
